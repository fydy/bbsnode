language: node_js
# When changing node version also update it on lines 31 and 49.
node_js:
  - "8"

sudo: required

services:
  - mongodb

directories:
    - node_modules
    
before_install:
  - git config --global user.name "fydy"
  - git config --global user.email "barberw@mail.lcc.edu"
  - git clone -b v1.10.x https://github.com/NodeBB/NodeBB.git
  - rm -rf NodeBB/.travis.yml
  - rm -rf config.json
  - mv NodeBB/* ./
  - cp install/package.json package.json
  - npm install nconf
  - npm install winston
  - npm install mkdirp
  - npm install mime
  - npm install graceful-fs
  - npm install xregexp
  - npm install --production
  
script: 
  - echo "npm test temporarily disabled"
  
install:
  - - sleep 15 # wait for mongodb to be ready
  - sh -c "if [ '$DB' = 'mongodb' ]; then node app --setup=\"{\\\"url\\\":\\\"http://bbs.yunc.me\\\",\\\"secret\\\":\\\"abcdef\\\",\\\"database\\\":\\\"mongo\\\",\\\"mongo:host\\\":\\\"ds151753.mlab.com\\\",\\\"mongo:port\\\":51753,\\\"mongo:username\\\":heroku_jc54t7c1,\\\"mongo:password\\\":u34c18s5sml6v3t66ka86qp3lt,\\\"mongo:database\\\":heroku_jc54t7c1,\\\"admin:username\\\":\\\"eryue\\\",\\\"admin:email\\\":\\\"chunxiaqiu13@gmail.com\\\",\\\"admin:password\\\":\\\"abcdef\\\",\\\"admin:password:confirm\\\":\\\"abcdef\\\"}\" --ci=\"{\\\"host\\\":\\\"ds151753.mlab.com\\\",\\\"port\\\":51753,\\\"database\\\":heroku_jc54t7c1}\";
  
after_success:
  - rm -rf .travis.yml
  - rm -rf NodeBB
  - git add --all .
  - git commit -m "Travis CI Auto Builder To Heroku"
  - git checkout -b nodebb
  - git push --quiet --force https://$ghost@github.com/fydy/bbsnode.git nodebb
