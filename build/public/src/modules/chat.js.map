{"version":3,"sources":["public/src/modules/chat.js"],"names":["define","components","taskbar","module","newMessage","loadChatsDropdown","chatsListEl","socket","emit","uid","app","user","after","err","data","alertError","message","rooms","filter","room","teaser","parseAndTranslate","html","find","not","remove","prepend","createUserTooltips","off","on","ev","$","target","parents","length","roomId","this","attr","ajaxify","currentPage","match","openChat","go","userslug","onChatMessageReceived","username","fromUser","isSelf","self","modalExists","require","ChatsMessages","modal","getModal","appendChatMessage","is","updateActive","scrollToBottom","template","chats","toggleNew","isFocused","updateTitleAndPlaySound","mid","push","title","roomName","touid","roomData","users","parseInt","silent","createModal","alternatingTitle","sounds","play","onUserStatusChange","updateUserStatus","status","onRoomRename","newTitle","newName","text","updateTitle","callback","scrollStop","Chats","chatModal","uuid","utils","generateUUID","dragged","css","appendTo","timeago","center","loadJQueryUI","resizable","handles","minHeight","minWidth","event","ui","originalSize","height","size","calculateChatListHeight","draggable","start","stop","focus","distance","handle","apply","close","gotoChats","get","val","window","one","minimize","e","which","addActionHandlers","addRenameHandler","addLeaveHandler","addSendHandlers","addMemberHandler","createAutoComplete","addScrollHandler","addCharactersLeftHandler","addIPHandler","onChatMessageEdit","icon","state","trigger","focusInput","clearInterval","discard","disableMobileBehaviour","closeByUUID","hideAfter","hasClass","removeClass","Math","max","width","outerWidth","scrollLeft","outerHeight","addClass","load","env","findBootstrapEnvironment","enableMobileBehaviour","modalEl","toggleNavbar","messagesEl"],"mappings":"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","file":"public/src/modules/chat.js","sourcesContent":["'use strict';\n\ndefine('chat', [\n\t'components',\n\t'taskbar',\n], function (components, taskbar) {\n\tvar module = {};\n\tvar newMessage = false;\n\n\tmodule.loadChatsDropdown = function (chatsListEl) {\n\t\tsocket.emit('modules.chats.getRecentChats', {\n\t\t\tuid: app.user.uid,\n\t\t\tafter: 0,\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar rooms = data.rooms.filter(function (room) {\n\t\t\t\treturn room.teaser;\n\t\t\t});\n\n\t\t\tapp.parseAndTranslate('partials/chats/dropdown', { rooms: rooms }, function (html) {\n\t\t\t\tchatsListEl.find('*').not('.navigation-link').remove();\n\t\t\t\tchatsListEl.prepend(html);\n\t\t\t\tapp.createUserTooltips(chatsListEl, 'right');\n\t\t\t\tchatsListEl.off('click').on('click', '[data-roomid]', function (ev) {\n\t\t\t\t\tif ($(ev.target).parents('.user-link').length) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tvar roomId = $(this).attr('data-roomid');\n\t\t\t\t\tif (!ajaxify.currentPage.match(/^chats\\//)) {\n\t\t\t\t\t\tapp.openChat(roomId);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + roomId);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\t$('[component=\"chats/mark-all-read\"]').off('click').on('click', function () {\n\t\t\t\t\tsocket.emit('modules.chats.markAllRead', function (err) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\n\tmodule.onChatMessageReceived = function (data) {\n\t\tvar username = data.message.fromUser.username;\n\t\tvar isSelf = data.self === 1;\n\t\tdata.message.self = data.self;\n\n\t\tnewMessage = data.self === 0;\n\t\tif (module.modalExists(data.roomId)) {\n\t\t\trequire(['forum/chats/messages'], function (ChatsMessages) {\n\t\t\t\tvar modal = module.getModal(data.roomId);\n\n\t\t\t\tChatsMessages.appendChatMessage(modal.find('.chat-content'), data.message);\n\n\t\t\t\tif (modal.is(':visible')) {\n\t\t\t\t\ttaskbar.updateActive(modal.attr('data-uuid'));\n\t\t\t\t\tChatsMessages.scrollToBottom(modal.find('.chat-content'));\n\t\t\t\t} else if (!ajaxify.data.template.chats) {\n\t\t\t\t\tmodule.toggleNew(modal.attr('data-uuid'), true, true);\n\t\t\t\t}\n\n\t\t\t\tif (!isSelf && (!modal.is(':visible') || !app.isFocused)) {\n\t\t\t\t\tupdateTitleAndPlaySound(data.message.mid, username);\n\t\t\t\t\ttaskbar.push('chat', modal.attr('data-uuid'), {\n\t\t\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || username),\n\t\t\t\t\t\ttouid: data.message.fromUser.uid,\n\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t} else if (!ajaxify.data.template.chats) {\n\t\t\tsocket.emit('modules.chats.loadRoom', {\n\t\t\t\troomId: data.roomId,\n\t\t\t}, function (err, roomData) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\troomData.users = roomData.users.filter(function (user) {\n\t\t\t\t\treturn user && parseInt(user.uid, 10) !== parseInt(app.user.uid, 10);\n\t\t\t\t});\n\t\t\t\troomData.silent = true;\n\t\t\t\troomData.uid = app.user.uid;\n\t\t\t\tmodule.createModal(roomData, function (modal) {\n\t\t\t\t\tmodule.toggleNew(modal.attr('data-uuid'), !isSelf, true);\n\t\t\t\t\tif (!isSelf) {\n\t\t\t\t\t\tupdateTitleAndPlaySound(data.message.mid, username);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction updateTitleAndPlaySound(mid, username) {\n\t\tapp.alternatingTitle('[[modules:chat.user_has_messaged_you, ' + username + ']]');\n\t\trequire(['sounds'], function (sounds) {\n\t\t\tsounds.play('chat-incoming', 'chat.incoming:' + mid);\n\t\t});\n\t}\n\n\tmodule.onUserStatusChange = function (data) {\n\t\tvar modal = module.getModal(data.uid);\n\t\tapp.updateUserStatus(modal.find('[component=\"user/status\"]'), data.status);\n\t};\n\n\tmodule.onRoomRename = function (data) {\n\t\tvar newTitle = $('<div/>').html(data.newName).text();\n\t\tvar modal = module.getModal(data.roomId);\n\t\tmodal.find('[component=\"chat/room/name\"]').text(newTitle);\n\t\ttaskbar.updateTitle('chat', modal.attr('data-uuid'), newTitle);\n\t};\n\n\tmodule.getModal = function (roomId) {\n\t\treturn $('#chat-modal-' + roomId);\n\t};\n\n\tmodule.modalExists = function (roomId) {\n\t\treturn $('#chat-modal-' + roomId).length !== 0;\n\t};\n\n\tmodule.createModal = function (data, callback) {\n\t\trequire(['scrollStop', 'forum/chats', 'forum/chats/messages'], function (scrollStop, Chats, ChatsMessages) {\n\t\t\tapp.parseAndTranslate('chat', data, function (chatModal) {\n\t\t\t\tvar uuid = utils.generateUUID();\n\t\t\t\tvar dragged = false;\n\n\t\t\t\tchatModal.attr('id', 'chat-modal-' + data.roomId);\n\t\t\t\tchatModal.attr('data-roomid', data.roomId);\n\t\t\t\tchatModal.attr('intervalId', 0);\n\t\t\t\tchatModal.attr('data-uuid', uuid);\n\t\t\t\tchatModal.css('position', 'fixed');\n\t\t\t\tchatModal.appendTo($('body'));\n\t\t\t\tchatModal.find('.timeago').timeago();\n\t\t\t\tmodule.center(chatModal);\n\n\t\t\t\tapp.loadJQueryUI(function () {\n\t\t\t\t\tchatModal.find('.modal-content').resizable({\n\t\t\t\t\t\thandles: 'n, e, s, w, se',\n\t\t\t\t\t\tminHeight: 250,\n\t\t\t\t\t\tminWidth: 400,\n\t\t\t\t\t});\n\n\t\t\t\t\tchatModal.find('.modal-content').on('resize', function (event, ui) {\n\t\t\t\t\t\tif (ui.originalSize.height === ui.size.height) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tchatModal.find('.modal-body').css('height', module.calculateChatListHeight(chatModal));\n\t\t\t\t\t});\n\n\t\t\t\t\tchatModal.draggable({\n\t\t\t\t\t\tstart: function () {\n\t\t\t\t\t\t\ttaskbar.updateActive(uuid);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tstop: function () {\n\t\t\t\t\t\t\tchatModal.find('#chat-message-input').focus();\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdistance: 10,\n\t\t\t\t\t\thandle: '.modal-header',\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\tscrollStop.apply(chatModal.find('[component=\"chat/messages\"]'));\n\n\t\t\t\tchatModal.find('#chat-close-btn').on('click', function () {\n\t\t\t\t\tmodule.close(chatModal);\n\t\t\t\t});\n\n\t\t\t\tfunction gotoChats() {\n\t\t\t\t\tvar text = components.get('chat/input').val();\n\t\t\t\t\t$(window).one('action:ajaxify.end', function () {\n\t\t\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t\t\t});\n\n\t\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + chatModal.attr('data-roomid'));\n\t\t\t\t\tmodule.close(chatModal);\n\t\t\t\t}\n\n\t\t\t\tchatModal.find('.modal-header').on('dblclick', gotoChats);\n\t\t\t\tchatModal.find('button[data-action=\"maximize\"]').on('click', gotoChats);\n\t\t\t\tchatModal.find('button[data-action=\"minimize\"]').on('click', function () {\n\t\t\t\t\tvar uuid = chatModal.attr('data-uuid');\n\t\t\t\t\tmodule.minimize(uuid);\n\t\t\t\t});\n\n\t\t\t\tchatModal.on('click', ':not(.close)', function () {\n\t\t\t\t\ttaskbar.updateActive(chatModal.attr('data-uuid'));\n\n\t\t\t\t\tif (dragged) {\n\t\t\t\t\t\tdragged = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tchatModal.on('mousemove', function (e) {\n\t\t\t\t\tif (e.which === 1) {\n\t\t\t\t\t\tdragged = true;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tchatModal.on('mousemove keypress click', function () {\n\t\t\t\t\tif (newMessage) {\n\t\t\t\t\t\tsocket.emit('modules.chats.markRead', data.roomId);\n\t\t\t\t\t\tnewMessage = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tChats.addActionHandlers(chatModal.find('[component=\"chat/messages\"]'), data.roomId);\n\t\t\t\tChats.addRenameHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"rename\"]'), data.roomName);\n\t\t\t\tChats.addLeaveHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"leave\"]'));\n\t\t\t\tChats.addSendHandlers(chatModal.attr('data-roomid'), chatModal.find('.chat-input'), chatModal.find('[data-action=\"send\"]'));\n\t\t\t\tChats.addMemberHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"members\"]'));\n\n\t\t\t\tChats.createAutoComplete(chatModal.find('[component=\"chat/input\"]'));\n\n\t\t\t\tChats.addScrollHandler(chatModal.attr('data-roomid'), data.uid, chatModal.find('.chat-content'));\n\n\t\t\t\tChats.addCharactersLeftHandler(chatModal);\n\t\t\t\tChats.addIPHandler(chatModal);\n\t\t\t\tChatsMessages.onChatMessageEdit();\n\n\t\t\t\ttaskbar.push('chat', chatModal.attr('data-uuid'), {\n\t\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || (data.users.length ? data.users[0].username : '')),\n\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\ticon: 'fa-comment',\n\t\t\t\t\tstate: '',\n\t\t\t\t});\n\n\t\t\t\t$(window).trigger('action:chat.loaded', chatModal);\n\n\t\t\t\tif (typeof callback === 'function') {\n\t\t\t\t\tcallback(chatModal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tmodule.focusInput = function (chatModal) {\n\t\tchatModal.find('[component=\"chat/input\"]').focus();\n\t};\n\n\tmodule.close = function (chatModal) {\n\t\tclearInterval(chatModal.attr('intervalId'));\n\t\tchatModal.attr('intervalId', 0);\n\t\tchatModal.remove();\n\t\tchatModal.data('modal', null);\n\t\ttaskbar.discard('chat', chatModal.attr('data-uuid'));\n\n\t\tif (chatModal.attr('data-mobile')) {\n\t\t\tmodule.disableMobileBehaviour(chatModal);\n\t\t}\n\t};\n\n\t// TODO: see taskbar.js:44\n\tmodule.closeByUUID = function (uuid) {\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\n\t\tmodule.close(chatModal);\n\t};\n\n\tmodule.center = function (chatModal) {\n\t\tvar hideAfter = false;\n\t\tif (chatModal.hasClass('hide')) {\n\t\t\tchatModal.removeClass('hide');\n\t\t\thideAfter = true;\n\t\t}\n\t\tchatModal.css('left', Math.max(0, (($(window).width() - $(chatModal).outerWidth()) / 2) + $(window).scrollLeft()) + 'px');\n\t\tchatModal.css('top', Math.max(0, ($(window).height() / 2) - ($(chatModal).outerHeight() / 2)) + 'px');\n\n\t\tif (hideAfter) {\n\t\t\tchatModal.addClass('hide');\n\t\t}\n\t\treturn chatModal;\n\t};\n\n\tmodule.load = function (uuid) {\n\t\trequire(['forum/chats/messages'], function (ChatsMessages) {\n\t\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\n\t\t\tchatModal.removeClass('hide');\n\t\t\ttaskbar.updateActive(uuid);\n\t\t\tChatsMessages.scrollToBottom(chatModal.find('.chat-content'));\n\t\t\tmodule.focusInput(chatModal);\n\t\t\tsocket.emit('modules.chats.markRead', chatModal.attr('data-roomid'));\n\n\t\t\tvar env = utils.findBootstrapEnvironment();\n\t\t\tif (env === 'xs' || env === 'sm') {\n\t\t\t\tmodule.enableMobileBehaviour(chatModal);\n\t\t\t}\n\t\t});\n\t};\n\n\tmodule.enableMobileBehaviour = function (modalEl) {\n\t\tapp.toggleNavbar(false);\n\t\tmodalEl.attr('data-mobile', '1');\n\t\tvar messagesEl = modalEl.find('.modal-body');\n\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\n\n\t\t$(window).on('resize', function () {\n\t\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\n\t\t});\n\t};\n\n\tmodule.disableMobileBehaviour = function () {\n\t\tapp.toggleNavbar(true);\n\t};\n\n\tmodule.calculateChatListHeight = function (modalEl) {\n\t\t// Formula: modal height minus header height. Simple(tm).\n\t\treturn modalEl.find('.modal-content').outerHeight() - modalEl.find('.modal-header').outerHeight();\n\t};\n\n\tmodule.minimize = function (uuid) {\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\n\t\tchatModal.addClass('hide');\n\t\ttaskbar.minimize('chat', uuid);\n\t\tclearInterval(chatModal.attr('intervalId'));\n\t\tchatModal.attr('intervalId', 0);\n\t};\n\n\tmodule.toggleNew = taskbar.toggleNew;\n\n\treturn module;\n});\n"]}