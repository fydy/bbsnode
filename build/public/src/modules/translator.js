"use strict";(function(e){function t(e,t){return Promise.resolve(jQuery.getJSON(config.relative_path+"/assets/language/"+e+"/"+t+".json?"+config["cache-buster"]))}var n=function(){console.warn.apply(console,arguments)};if(typeof define==="function"&&define.amd){define("translator",[],function(){return e(utils,t,n)})}else if(typeof module==="object"&&module.exports){(function(){var t=require("../../../src/languages");if(global.env==="development"){var r=require("winston");n=function(e){r.warn(e)}}function a(e,n){return new Promise(function(r,a){t.get(e,n,function(e,t){if(e){a(e)}else{r(t)}})})}module.exports=e(require("../utils"),a,n)})()}})(function(e,t,n){var r=Object.assign||jQuery.extend;function a(t){return e.escapeHTML(e.decodeHTMLEntities(String(t).replace(/[\s\xa0]+/g," ").replace(/^\s+|\s+$/g,"")))}var i=function(){function r(e){var t=this;if(!e){throw new TypeError("Parameter `language` must be a language string. Received "+e+(e===""?"(empty string)":""))}t.modules=Object.keys(r.moduleFactories).map(function(t){var n=r.moduleFactories[t];return[t,n(e)]}).reduce(function(e,t){var n=t[0];var r=t[1];e[n]=r;return e},{});t.lang=e;t.translations={}}r.prototype.load=t;r.prototype.translate=function e(t){var n="a-zA-Z0-9\\-_.\\/";var r=new RegExp("["+n+"]");var a=new RegExp("[^"+n+"\\]]");var i=0;var o=0;var s=t.length;var u=[];var c=false;function l(e){var t=e.length;var n=[];var r=0;var a=0;var i=0;while(r+2<=t){if(e[r]==="["&&e[r+1]==="["){i+=1;r+=1}else if(e[r]==="]"&&e[r+1]==="]"){i-=1;r+=1}else if(i===0&&e[r]===","&&e[r-1]!=="\\"){n.push(e.slice(a,r).trim());r+=1;a=r}r+=1}n.push(e.slice(a,r+1).trim());return n}i=t.indexOf("[[",i);while(i+2<=s&&i!==-1){u.push(t.slice(o,i));i+=2;o=i;c=true;var f=0;var g;var v;var p=false;var h=false;var m=false;var d=false;while(i+2<=s){g=t[i];v=t[i+1];if(!p&&r.test(g)){p=true;i+=1}else if(p&&!h&&g===":"){h=true;i+=1}else if(h&&!m&&r.test(g)){m=true;i+=1}else if(m&&!d&&g===","){d=true;i+=1}else if(!(p&&h&&m&&d)&&a.test(g)){i+=1;o-=2;c=false;if(f>0){f-=1}else{break}}else if(g==="["&&v==="["){f+=1;i+=2}else if(g==="]"&&v==="]"){if(f===0){var y=t.slice(o,i);var j=l(y);var w=j[0];var T=j.slice(1);var b="";if(T&&T.length){b=this.translate(y)}u.push(this.translateKey(w,T,b));i+=2;o=i;c=false;break}f-=1;i+=2}else{i+=1}}i=t.indexOf("[[",i)}var q=t.slice(o);if(c){q=this.translate(q)}u.push(q);return Promise.all(u).then(function(e){return e.join("")})};r.prototype.translateKey=function e(t,r,i){var o=this;var s=t.split(":",2);var u=s[0];var c=s[1];if(o.modules[u]){return Promise.resolve(o.modules[u](c,r))}if(u&&!c){n('Missing key in translation token "'+t+'"');return Promise.resolve("[["+u+"]]")}var l=this.getTranslation(u,c);return l.then(function(e){if(!e){n('Missing translation "'+t+'"');return i||c}var s=r.map(function(e){return o.translate(a(e))});return Promise.all(s).then(function(t){var n=e;t.forEach(function(e,t){var r=e.replace(/%(?=\d)/g,"&#37;").replace(/\\,/g,"&#44;");n=n.replace(new RegExp("%"+(t+1),"g"),r)});return n})})};r.prototype.getTranslation=function e(t,r){var a;if(!t){n("[translator] Parameter `namespace` is "+t+(t===""?"(empty string)":""));a=Promise.resolve({})}else{this.translations[t]=this.translations[t]||this.load(this.lang,t).catch(function(){return{}});a=this.translations[t]}if(r){return a.then(function(e){return e[r]})}return a};function i(e){var t=[];function n(e){if(e.nodeType===3){t.push(e)}else{for(var r=0,a=e.childNodes,i=a.length;r<i;r+=1){n(a[r])}}}n(e);return t}r.prototype.translateInPlace=function e(t,n){n=n||["placeholder","title"];var r=i(t);var a=r.map(function(e){return e.nodeValue}).join("  ||  ");var o=n.reduce(function(e,n){var r=Array.prototype.map.call(t.querySelectorAll("["+n+'*="[["]'),function(e){return[n,e]});return e.concat(r)},[]);var s=o.map(function(e){return e[1].getAttribute(e[0])}).join("  ||  ");return Promise.all([this.translate(a),this.translate(s)]).then(function(e){var t=e[0];var n=e[1];if(t){t.split("  ||  ").forEach(function(e,t){$(r[t]).replaceWith(e)})}if(n){n.split("  ||  ").forEach(function(e,t){o[t][1].setAttribute(o[t][0],e)})}})};r.getLanguage=function t(){var n;if(typeof window==="object"&&window.config&&window.utils){n=e.params().lang||config.userLang||config.defaultLang||"en-GB"}else{var r=require("../../../src/meta");n=r.config&&r.config.defaultLang?r.config.defaultLang:"en-GB"}return n};r.create=function e(t){if(!t){t=r.getLanguage()}r.cache[t]=r.cache[t]||new r(t);return r.cache[t]};r.cache={};r.registerModule=function e(t,n){r.moduleFactories[t]=n;Object.keys(r.cache).forEach(function(e){var a=r.cache[e];a.modules[t]=n(a.lang)})};r.moduleFactories={};r.removePatterns=function e(t){var n=t.length;var r=0;var a=0;var i=0;var o="";var s;while(r<n){s=t.slice(r,r+2);if(s==="[["){if(i===0){o+=t.slice(a,r)}i+=1;r+=2}else if(s==="]]"){i-=1;r+=2;if(i===0){a=r}}else{r+=1}}o+=t.slice(a,r);return o};r.escape=function e(t){return typeof t==="string"?t.replace(/\[\[/g,"&lsqb;&lsqb;").replace(/\]\]/g,"&rsqb;&rsqb;"):t};r.unescape=function e(t){return typeof t==="string"?t.replace(/&lsqb;|\\\[/g,"[").replace(/&rsqb;|\\\]/g,"]"):t};r.compile=function e(){var t=Array.prototype.slice.call(arguments,0).map(function(e){return String(e).replace(/%/g,"&#37;").replace(/,/g,"&#44;")});return"[["+t.join(", ")+"]]"};return r}();var o={Translator:i,compile:i.compile,escape:i.escape,unescape:i.unescape,getLanguage:i.getLanguage,translate:function e(t,r,a){var o=a;var s=r;if(typeof r==="function"){o=r;s=null}if(!(typeof t==="string"||t instanceof String)||t===""){return o("")}return i.create(s).translate(t).then(function(e){if(o){setTimeout(o,0,e)}return e},function(e){n("Translation failed: "+e.stack)})},addTranslation:function e(t,n,a){i.create(t).getTranslation(n).then(function(e){r(e,a)})},getTranslations:function e(t,n,r){r=r||function(){};i.create(t).getTranslation(n).then(r)},load:function e(t,n,r){o.getTranslations(t,n,r)},toggleTimeagoShorthand:function t(n){function a(){var e=r({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=r({},o.timeagoShort);o.timeagoShort=r({},e);if(typeof n==="function"){n()}}if(!o.timeagoShort){var i=e.userLangToTimeagoCode(config.userLang);if(!config.timeagoCodes.includes(i+"-short")){i="en"}var s=r({},jQuery.timeago.settings.strings);jQuery.getScript(config.relative_path+"/assets/vendor/jquery/timeago/locales/jquery.timeago."+i+"-short.js").done(function(){o.timeagoShort=r({},jQuery.timeago.settings.strings);jQuery.timeago.settings.strings=r({},s);a()})}else{a()}},switchTimeagoLanguage:function t(n){delete o.timeagoShort;var r=e.userLangToTimeagoCode(config.userLang);if(!config.timeagoCodes.includes(r+"-short")){r="en"}jQuery.getScript(config.relative_path+"/assets/vendor/jquery/timeago/locales/jquery.timeago."+r+".js").done(n)},prepareDOM:function e(){o.translate("[[language:dir]]",function(e){if(e&&!$("html").attr("data-dir")){jQuery("html").css("direction",e).attr("data-dir",e)}})}};return o});
//# sourceMappingURL=translator.js.map