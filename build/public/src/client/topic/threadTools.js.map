{"version":3,"sources":["public/src/client/topic/threadTools.js"],"names":["define","components","translator","ThreadTools","init","tid","renderMenu","topicContainer","$","on","topicCommand","socket","emit","tids","cid","ajaxify","data","err","app","alertError","alertSuccess","btn","this","message","parents","find","trigger","require","move","deletePosts","fork","movePosts","changeWatching","type","alert","alert_id","title","timeout","setFollowState","window","$this","dropdownMenu","html","parseAndTranslate","command","translate","msg","bootbox","confirm","setLockedState","threadEl","get","parseInt","attr","isLocked","privileges","isAdminOrMod","toggleClass","parent","hideReply","deleted","user","uid","locked","setDeleteState","isDelete","setPinnedState","isPinned","pinned","state","menu"],"mappings":"AAAA,aAGAA,OAAO,2BACN,aACA,cACE,SAAUC,EAAYC,GACxB,IAAIC,KAEJA,EAAYC,KAAO,SAAUC,GAC5BC,IAEA,IAAIC,EAAiBC,EAAE,UAEvBD,EAAeE,GAAG,QAAS,6BAA8B,WACxDC,EAAa,SAAUL,GACvB,OAAO,QAGRE,EAAeE,GAAG,QAAS,8BAA+B,WACzDC,EAAa,UAAWL,GACxB,OAAO,QAGRE,EAAeE,GAAG,QAAS,4BAA6B,WACvDC,EAAa,QAASL,GACtB,OAAO,QAGRE,EAAeE,GAAG,QAAS,2BAA4B,WACtDE,OAAOC,KAAK,eAAiBC,MAAOR,GAAMS,IAAKC,QAAQC,KAAKF,MAC5D,OAAO,QAGRP,EAAeE,GAAG,QAAS,6BAA8B,WACxDE,OAAOC,KAAK,iBAAmBC,MAAOR,GAAMS,IAAKC,QAAQC,KAAKF,MAC9D,OAAO,QAGRP,EAAeE,GAAG,QAAS,0BAA2B,WACrDE,OAAOC,KAAK,cAAgBC,MAAOR,GAAMS,IAAKC,QAAQC,KAAKF,MAC3D,OAAO,QAGRP,EAAeE,GAAG,QAAS,4BAA6B,WACvDE,OAAOC,KAAK,gBAAkBC,MAAOR,GAAMS,IAAKC,QAAQC,KAAKF,MAC7D,OAAO,QAGRP,EAAeE,GAAG,QAAS,kCAAmC,WAC7DE,OAAOC,KAAK,oBAAqBP,EAAK,SAAUY,GAC/C,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,GAEvBC,IAAIE,aAAa,mCAElB,OAAO,QAGRb,EAAeE,GAAG,QAAS,0CAA2C,WACrE,IAAIY,EAAMb,EAAEc,MACZX,OAAOC,KAAK,6BAA8BP,GAAM,SAAUY,GACzD,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIM,SAE3BL,IAAIE,aAAa,wCACjBC,EAAIG,QAAQ,sBAAsBC,KAAK,oBAAoBC,QAAQ,WAEpE,OAAO,QAGRnB,EAAeE,GAAG,QAAS,2BAA4B,WACtDkB,SAAS,oBAAqB,SAAUC,GACvCA,EAAKxB,MAAMC,GAAMU,QAAQC,KAAKF,OAE/B,OAAO,QAGRP,EAAeE,GAAG,QAAS,mCAAoC,WAC9DkB,SAAS,4BAA6B,SAAUE,GAC/CA,EAAYzB,WAIdG,EAAeE,GAAG,QAAS,2BAA4B,WACtDkB,SAAS,oBAAqB,SAAUG,GACvCA,EAAK1B,WAIPG,EAAeE,GAAG,QAAS,iCAAkC,WAC5DkB,SAAS,yBAA0B,SAAUI,GAC5CA,EAAU3B,WAIZG,EAAeE,GAAG,QAAS,gCAAiC,WAC3DuB,EAAe,YAEhBzB,EAAeE,GAAG,QAAS,oCAAqC,WAC/DuB,EAAe,cAEhBzB,EAAeE,GAAG,QAAS,+BAAgC,WAC1DuB,EAAe,YAGhB,SAASA,EAAeC,GACvBtB,OAAOC,KAAK,yBAA2BP,IAAKA,EAAK4B,KAAMA,GAAQ,SAAUhB,GACxE,GAAIA,EAAK,CACR,OAAOC,IAAIgB,OACVD,KAAM,SACNE,SAAU,eACVC,MAAO,2BACPb,QAAS,+BACTc,QAAS,MAGX,IAAId,EAAU,GACd,GAAIU,IAAS,SAAU,CACtBV,EAAU,yCACJ,GAAIU,IAAS,WAAY,CAC/BV,EAAU,6CACJ,GAAIU,IAAS,SAAU,CAC7BV,EAAU,mCAEXe,EAAeL,GAEff,IAAIgB,OACHC,SAAU,gBACVZ,QAASA,EACTU,KAAM,UACNI,QAAS,MAGV7B,EAAE+B,QAAQb,QAAQ,gCAAkCrB,IAAKA,EAAK4B,KAAMA,MAGrE,OAAO,QAIT,SAAS3B,IACRE,EAAE,UAAUC,GAAG,mBAAoB,gBAAiB,WACnD,IAAI+B,EAAQhC,EAAEc,MACd,IAAImB,EAAeD,EAAMf,KAAK,kBAC9B,GAAIgB,EAAaC,OAAQ,CACxB,OAGD/B,OAAOC,KAAK,yBAA2BP,IAAKU,QAAQC,KAAKX,IAAKS,IAAKC,QAAQC,KAAKF,KAAO,SAAUG,EAAKD,GACrG,GAAIC,EAAK,CACR,OAAOC,IAAIC,WAAWF,GAEvBC,IAAIyB,kBAAkB,iCAAkC3B,EAAM,SAAU0B,GACvED,EAAaC,KAAKA,GAClBlC,EAAE+B,QAAQb,QAAQ,iCAMtB,SAAShB,EAAakC,EAASvC,GAC9BH,EAAW2C,UAAU,wBAA0BD,EAAU,aAAc,SAAUE,GAChFC,QAAQC,QAAQF,EAAK,SAAUE,GAC9B,IAAKA,EAAS,CACb,OAGDrC,OAAOC,KAAK,UAAYgC,GAAW/B,MAAOR,GAAMS,IAAKC,QAAQC,KAAKF,KAAO,SAAUG,GAClF,GAAIA,EAAK,CACRC,IAAIC,WAAWF,EAAIM,gBAOxBpB,EAAY8C,eAAiB,SAAUjC,GACtC,IAAIkC,EAAWjD,EAAWkD,IAAI,SAC9B,GAAIC,SAASpC,EAAKX,IAAK,MAAQ+C,SAASF,EAASG,KAAK,YAAa,IAAK,CACvE,OAGD,IAAIC,EAAWtC,EAAKsC,WAAavC,QAAQC,KAAKuC,WAAWC,aAEzDvD,EAAWkD,IAAI,cAAcM,YAAY,SAAUzC,EAAKsC,UAAUI,SAASL,KAAK,SAAUrC,EAAKsC,SAAW,GAAK,MAC/GrD,EAAWkD,IAAI,gBAAgBM,YAAY,UAAWzC,EAAKsC,UAAUI,SAASL,KAAK,UAAWrC,EAAKsC,SAAW,GAAK,MAEnH,IAAIK,GAAa3C,EAAKsC,UAAYvC,QAAQC,KAAK4C,WAAa7C,QAAQC,KAAKuC,WAAWC,aAEpFvD,EAAWkD,IAAI,yBAAyBM,YAAY,SAAUE,GAC9D1D,EAAWkD,IAAI,sBAAsBM,YAAY,SAAU1C,QAAQC,KAAKuC,WAAWC,eAAiBxC,EAAKsC,UAAYvC,QAAQC,KAAK4C,SAElIV,EAASzB,KAAK,wHAAwHgC,YAAY,SAAUE,GAC5JT,EAASzB,KAAK,sDAAsDgC,YAAY,SAAUH,GAE1FJ,EAASzB,KAAK,gCAAkCP,IAAI2C,KAAKC,IAAM,uCAAuCL,YAAY,SAAUH,GAE5H9C,EAAE,uCAAuCiD,YAAY,UAAWzC,EAAKsC,UACrE9C,EAAE,2CAA2CkC,KAAK,IAClD3B,QAAQC,KAAK+C,OAAS/C,EAAKsC,UAG5BnD,EAAY6D,eAAiB,SAAUhD,GACtC,IAAIkC,EAAWjD,EAAWkD,IAAI,SAC9B,GAAIC,SAASpC,EAAKX,IAAK,MAAQ+C,SAASF,EAASG,KAAK,YAAa,IAAK,CACvE,OAGDpD,EAAWkD,IAAI,gBAAgBM,YAAY,SAAUzC,EAAKiD,UAAUP,SAASL,KAAK,SAAUrC,EAAKiD,SAAW,GAAK,MACjHhE,EAAWkD,IAAI,iBAAiBM,YAAY,UAAWzC,EAAKiD,UAAUP,SAASL,KAAK,UAAWrC,EAAKiD,SAAW,GAAK,MACpHhE,EAAWkD,IAAI,eAAeM,YAAY,UAAWzC,EAAKiD,UAAUP,SAASL,KAAK,UAAWrC,EAAKiD,SAAW,GAAK,MAClHhE,EAAWkD,IAAI,yBAAyBM,YAAY,UAAWzC,EAAKiD,UAEpE,IAAIN,EAAY3C,EAAKiD,WAAalD,QAAQC,KAAKuC,WAAWC,aAE1DvD,EAAWkD,IAAI,yBAAyBM,YAAY,SAAUE,GAC9D1D,EAAWkD,IAAI,sBAAsBM,YAAY,SAAU1C,QAAQC,KAAKuC,WAAWC,eAAiBzC,QAAQC,KAAK+C,QAAU/C,EAAKiD,UAChIf,EAASzB,KAAK,wHAAwHgC,YAAY,SAAUE,GAE5JT,EAASO,YAAY,UAAWzC,EAAKiD,UACrClD,QAAQC,KAAK4C,QAAU5C,EAAKiD,UAI7B9D,EAAY+D,eAAiB,SAAUlD,GACtC,IAAIkC,EAAWjD,EAAWkD,IAAI,SAC9B,GAAIC,SAASpC,EAAKX,IAAK,MAAQ+C,SAASF,EAASG,KAAK,YAAa,IAAK,CACvE,OAGDpD,EAAWkD,IAAI,aAAaM,YAAY,SAAUzC,EAAKmD,UAAUT,SAASL,KAAK,SAAUrC,EAAKmD,SAAW,GAAK,MAC9GlE,EAAWkD,IAAI,eAAeM,YAAY,UAAWzC,EAAKmD,UAAUT,SAASL,KAAK,UAAWrC,EAAKmD,SAAW,GAAK,MAClH3D,EAAE,6CAA6CiD,YAAY,UAAWzC,EAAKmD,UAC3EpD,QAAQC,KAAKoD,OAASpD,EAAKmD,UAG5B,SAAS7B,EAAe+B,GACvB,IAAIC,EAAOrE,EAAWkD,IAAI,wBAC1BmB,EAAKb,YAAY,SAAUY,IAAU,UACrCpE,EAAWkD,IAAI,yBAAyBM,YAAY,WAAYY,IAAU,UAE1EC,EAAOrE,EAAWkD,IAAI,4BACtBmB,EAAKb,YAAY,SAAUY,IAAU,YACrCpE,EAAWkD,IAAI,6BAA6BM,YAAY,WAAYY,IAAU,YAE9EC,EAAOrE,EAAWkD,IAAI,uBACtBmB,EAAKb,YAAY,SAAUY,IAAU,UACrCpE,EAAWkD,IAAI,wBAAwBM,YAAY,WAAYY,IAAU,UAI1E,OAAOlE","file":"public/src/client/topic/threadTools.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/threadTools', [\n\t'components',\n\t'translator',\n], function (components, translator) {\n\tvar ThreadTools = {};\n\n\tThreadTools.init = function (tid) {\n\t\trenderMenu();\n\n\t\tvar topicContainer = $('.topic');\n\n\t\ttopicContainer.on('click', '[component=\"topic/delete\"]', function () {\n\t\t\ttopicCommand('delete', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/restore\"]', function () {\n\t\t\ttopicCommand('restore', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/purge\"]', function () {\n\t\t\ttopicCommand('purge', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/lock\"]', function () {\n\t\t\tsocket.emit('topics.lock', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/unlock\"]', function () {\n\t\t\tsocket.emit('topics.unlock', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/pin\"]', function () {\n\t\t\tsocket.emit('topics.pin', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/unpin\"]', function () {\n\t\t\tsocket.emit('topics.unpin', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread\"]', function () {\n\t\t\tsocket.emit('topics.markUnread', tid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('[[topic:mark_unread.success]]');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread-for-all\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\tsocket.emit('topics.markAsUnreadForAll', [tid], function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('[[topic:markAsUnreadForAll.success]]');\n\t\t\t\tbtn.parents('.thread-tools.open').find('.dropdown-toggle').trigger('click');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/move\"]', function () {\n\t\t\trequire(['forum/topic/move'], function (move) {\n\t\t\t\tmove.init([tid], ajaxify.data.cid);\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/delete/posts\"]', function () {\n\t\t\trequire(['forum/topic/delete-posts'], function (deletePosts) {\n\t\t\t\tdeletePosts.init();\n\t\t\t});\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/fork\"]', function () {\n\t\t\trequire(['forum/topic/fork'], function (fork) {\n\t\t\t\tfork.init();\n\t\t\t});\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/move-posts\"]', function () {\n\t\t\trequire(['forum/topic/move-post'], function (movePosts) {\n\t\t\t\tmovePosts.init();\n\t\t\t});\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/following\"]', function () {\n\t\t\tchangeWatching('follow');\n\t\t});\n\t\ttopicContainer.on('click', '[component=\"topic/not-following\"]', function () {\n\t\t\tchangeWatching('unfollow');\n\t\t});\n\t\ttopicContainer.on('click', '[component=\"topic/ignoring\"]', function () {\n\t\t\tchangeWatching('ignore');\n\t\t});\n\n\t\tfunction changeWatching(type) {\n\t\t\tsocket.emit('topics.changeWatching', { tid: tid, type: type }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alert({\n\t\t\t\t\t\ttype: 'danger',\n\t\t\t\t\t\talert_id: 'topic_follow',\n\t\t\t\t\t\ttitle: '[[global:please_log_in]]',\n\t\t\t\t\t\tmessage: '[[topic:login_to_subscribe]]',\n\t\t\t\t\t\ttimeout: 5000,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tvar message = '';\n\t\t\t\tif (type === 'follow') {\n\t\t\t\t\tmessage = '[[topic:following_topic.message]]';\n\t\t\t\t} else if (type === 'unfollow') {\n\t\t\t\t\tmessage = '[[topic:not_following_topic.message]]';\n\t\t\t\t} else if (type === 'ignore') {\n\t\t\t\t\tmessage = '[[topic:ignoring_topic.message]]';\n\t\t\t\t}\n\t\t\t\tsetFollowState(type);\n\n\t\t\t\tapp.alert({\n\t\t\t\t\talert_id: 'follow_thread',\n\t\t\t\t\tmessage: message,\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\ttimeout: 5000,\n\t\t\t\t});\n\n\t\t\t\t$(window).trigger('action:topics.changeWatching', { tid: tid, type: type });\n\t\t\t});\n\n\t\t\treturn false;\n\t\t}\n\t};\n\n\tfunction renderMenu() {\n\t\t$('.topic').on('show.bs.dropdown', '.thread-tools', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\n\t\t\tif (dropdownMenu.html()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsocket.emit('topics.loadTopicTools', { tid: ajaxify.data.tid, cid: ajaxify.data.cid }, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tapp.parseAndTranslate('partials/topic/topic-menu-list', data, function (html) {\n\t\t\t\t\tdropdownMenu.html(html);\n\t\t\t\t\t$(window).trigger('action:topic.tools.load');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction topicCommand(command, tid) {\n\t\ttranslator.translate('[[topic:thread_tools.' + command + '_confirm]]', function (msg) {\n\t\t\tbootbox.confirm(msg, function (confirm) {\n\t\t\t\tif (!confirm) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsocket.emit('topics.' + command, { tids: [tid], cid: ajaxify.data.cid }, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tThreadTools.setLockedState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar isLocked = data.isLocked && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/lock').toggleClass('hidden', data.isLocked).parent().attr('hidden', data.isLocked ? '' : null);\n\t\tcomponents.get('topic/unlock').toggleClass('hidden', !data.isLocked).parent().attr('hidden', !data.isLocked ? '' : null);\n\n\t\tvar hideReply = (data.isLocked || ajaxify.data.deleted) && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !data.isLocked || ajaxify.data.deleted);\n\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\n\t\tthreadEl.find('[component=\"post/edit\"], [component=\"post/delete\"]').toggleClass('hidden', isLocked);\n\n\t\tthreadEl.find('[component=\"post\"][data-uid=\"' + app.user.uid + '\"].deleted [component=\"post/tools\"]').toggleClass('hidden', isLocked);\n\n\t\t$('[component=\"post/header\"] i.fa-lock').toggleClass('hidden', !data.isLocked);\n\t\t$('[component=\"post/tools\"] .dropdown-menu').html('');\n\t\tajaxify.data.locked = data.isLocked;\n\t};\n\n\tThreadTools.setDeleteState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tcomponents.get('topic/delete').toggleClass('hidden', data.isDelete).parent().attr('hidden', data.isDelete ? '' : null);\n\t\tcomponents.get('topic/restore').toggleClass('hidden', !data.isDelete).parent().attr('hidden', !data.isDelete ? '' : null);\n\t\tcomponents.get('topic/purge').toggleClass('hidden', !data.isDelete).parent().attr('hidden', !data.isDelete ? '' : null);\n\t\tcomponents.get('topic/deleted/message').toggleClass('hidden', !data.isDelete);\n\n\t\tvar hideReply = data.isDelete && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !ajaxify.data.locked || data.isDelete);\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\n\n\t\tthreadEl.toggleClass('deleted', data.isDelete);\n\t\tajaxify.data.deleted = data.isDelete;\n\t};\n\n\n\tThreadTools.setPinnedState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tcomponents.get('topic/pin').toggleClass('hidden', data.isPinned).parent().attr('hidden', data.isPinned ? '' : null);\n\t\tcomponents.get('topic/unpin').toggleClass('hidden', !data.isPinned).parent().attr('hidden', !data.isPinned ? '' : null);\n\t\t$('[component=\"post/header\"] i.fa-thumb-tack').toggleClass('hidden', !data.isPinned);\n\t\tajaxify.data.pinned = data.isPinned;\n\t};\n\n\tfunction setFollowState(state) {\n\t\tvar menu = components.get('topic/following/menu');\n\t\tmenu.toggleClass('hidden', state !== 'follow');\n\t\tcomponents.get('topic/following/check').toggleClass('fa-check', state === 'follow');\n\n\t\tmenu = components.get('topic/not-following/menu');\n\t\tmenu.toggleClass('hidden', state !== 'unfollow');\n\t\tcomponents.get('topic/not-following/check').toggleClass('fa-check', state === 'unfollow');\n\n\t\tmenu = components.get('topic/ignoring/menu');\n\t\tmenu.toggleClass('hidden', state !== 'ignore');\n\t\tcomponents.get('topic/ignoring/check').toggleClass('fa-check', state === 'ignore');\n\t}\n\n\n\treturn ThreadTools;\n});\n"]}