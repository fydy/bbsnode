{"version":3,"sources":["public/src/client/search.js"],"names":["define","searchModule","autocomplete","storage","Search","init","searchQuery","$","attr","searchIn","on","updateFormItemVisiblity","val","highlightMatches","off","e","preventDefault","query","getSearchDataFromDOM","handleSavePreferences","enableAutoComplete","fillOutForm","form","searchData","in","term","matchWords","find","by","tagsinput","categories","searchChildren","is","hasTags","replies","repliesFilter","timeFilter","timeRange","sortBy","sortDirection","showAs","window","trigger","data","hide","indexOf","toggleClass","params","utils","getSearchPreferences","formData","merge","ajaxify","Array","isArray","forEach","prop","tag","searchDefaultSortBy","isTopic","isPost","parent","escapeHTML","replace","trim","regexStr","split","join","regex","RegExp","escapeRegexChars","each","result","this","nested","after","length","push","append","html","match","p1","nestedEl","i","addClass","setItem","JSON","stringify","app","alertSuccess","removeItem","reset","userEl","confirmKeys","trimValue","user","siblings","tagEl"],"mappings":"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","file":"public/src/client/search.js","sourcesContent":["'use strict';\n\n\ndefine('forum/search', ['search', 'autocomplete', 'storage'], function (searchModule, autocomplete, storage) {\n\tvar\tSearch = {};\n\n\tSearch.init = function () {\n\t\tvar searchQuery = $('#results').attr('data-search-query');\n\n\t\tvar searchIn = $('#search-in');\n\n\t\tsearchIn.on('change', function () {\n\t\t\tupdateFormItemVisiblity(searchIn.val());\n\t\t});\n\n\t\thighlightMatches(searchQuery);\n\n\t\t$('#advanced-search').off('submit').on('submit', function (e) {\n\t\t\te.preventDefault();\n\t\t\tsearchModule.query(getSearchDataFromDOM(), function () {\n\t\t\t\t$('#search-input').val('');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\thandleSavePreferences();\n\n\t\tenableAutoComplete();\n\n\t\tfillOutForm();\n\t};\n\n\tfunction getSearchDataFromDOM() {\n\t\tvar form = $('#advanced-search');\n\t\tvar searchData = {\n\t\t\tin: $('#search-in').val(),\n\t\t};\n\t\tsearchData.term = $('#search-input').val();\n\t\tif (searchData.in === 'posts' || searchData.in === 'titlesposts' || searchData.in === 'titles') {\n\t\t\tsearchData.matchWords = form.find('#match-words-filter').val();\n\t\t\tsearchData.by = form.find('#posted-by-user').tagsinput('items');\n\t\t\tsearchData.categories = form.find('#posted-in-categories').val();\n\t\t\tsearchData.searchChildren = form.find('#search-children').is(':checked');\n\t\t\tsearchData.hasTags = form.find('#has-tags').tagsinput('items');\n\t\t\tsearchData.replies = form.find('#reply-count').val();\n\t\t\tsearchData.repliesFilter = form.find('#reply-count-filter').val();\n\t\t\tsearchData.timeFilter = form.find('#post-time-filter').val();\n\t\t\tsearchData.timeRange = form.find('#post-time-range').val();\n\t\t\tsearchData.sortBy = form.find('#post-sort-by').val();\n\t\t\tsearchData.sortDirection = form.find('#post-sort-direction').val();\n\t\t\tsearchData.showAs = form.find('#show-as-topics').is(':checked') ? 'topics' : 'posts';\n\t\t}\n\n\t\t$(window).trigger('action:search.getSearchDataFromDOM', {\n\t\t\tform: form,\n\t\t\tdata: searchData,\n\t\t});\n\n\t\treturn searchData;\n\t}\n\n\tfunction updateFormItemVisiblity(searchIn) {\n\t\tvar hide = searchIn.indexOf('posts') === -1 && searchIn.indexOf('titles') === -1;\n\t\t$('.post-search-item').toggleClass('hide', hide);\n\t}\n\n\tfunction fillOutForm() {\n\t\tvar params = utils.params();\n\n\t\tvar searchData = searchModule.getSearchPreferences();\n\t\tvar formData = utils.merge(searchData, params);\n\n\t\tif (formData) {\n\t\t\tif (ajaxify.data.term) {\n\t\t\t\t$('#search-input').val(ajaxify.data.term);\n\t\t\t}\n\t\t\tformData.in = formData.in || 'posts';\n\t\t\t$('#search-in').val(formData.in);\n\t\t\tupdateFormItemVisiblity(formData.in);\n\n\t\t\tif (formData.matchWords) {\n\t\t\t\t$('#match-words-filter').val(formData.matchWords);\n\t\t\t}\n\n\t\t\tif (formData.by) {\n\t\t\t\tformData.by = Array.isArray(formData.by) ? formData.by : [formData.by];\n\t\t\t\tformData.by.forEach(function (by) {\n\t\t\t\t\t$('#posted-by-user').tagsinput('add', by);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (formData.categories) {\n\t\t\t\t$('#posted-in-categories').val(formData.categories);\n\t\t\t}\n\n\t\t\tif (formData.searchChildren) {\n\t\t\t\t$('#search-children').prop('checked', true);\n\t\t\t}\n\n\t\t\tif (formData.hasTags) {\n\t\t\t\tformData.hasTags = Array.isArray(formData.hasTags) ? formData.hasTags : [formData.hasTags];\n\t\t\t\tformData.hasTags.forEach(function (tag) {\n\t\t\t\t\t$('#has-tags').tagsinput('add', tag);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (formData.replies) {\n\t\t\t\t$('#reply-count').val(formData.replies);\n\t\t\t\t$('#reply-count-filter').val(formData.repliesFilter);\n\t\t\t}\n\n\t\t\tif (formData.timeRange) {\n\t\t\t\t$('#post-time-range').val(formData.timeRange);\n\t\t\t\t$('#post-time-filter').val(formData.timeFilter);\n\t\t\t}\n\n\t\t\tif (formData.sortBy || ajaxify.data.searchDefaultSortBy) {\n\t\t\t\t$('#post-sort-by').val(formData.sortBy || ajaxify.data.searchDefaultSortBy);\n\t\t\t}\n\t\t\t$('#post-sort-direction').val(formData.sortDirection || 'desc');\n\n\t\t\tif (formData.showAs) {\n\t\t\t\tvar isTopic = formData.showAs === 'topics';\n\t\t\t\tvar isPost = formData.showAs === 'posts';\n\t\t\t\t$('#show-as-topics').prop('checked', isTopic).parent().toggleClass('active', isTopic);\n\t\t\t\t$('#show-as-posts').prop('checked', isPost).parent().toggleClass('active', isPost);\n\t\t\t}\n\n\t\t\t$(window).trigger('action:search.fillOutForm', {\n\t\t\t\tform: formData,\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction highlightMatches(searchQuery) {\n\t\tif (!searchQuery) {\n\t\t\treturn;\n\t\t}\n\t\tsearchQuery = utils.escapeHTML(searchQuery.replace(/^\"/, '').replace(/\"$/, '').trim());\n\t\tvar regexStr = searchQuery.split(' ').join('|');\n\t\tvar regex = new RegExp('(' + utils.escapeRegexChars(regexStr) + ')', 'gi');\n\n\t\t$('.search-result-text p, .search-result-text h4').each(function () {\n\t\t\tvar result = $(this);\n\t\t\tvar nested = [];\n\n\t\t\tresult.find('*').each(function () {\n\t\t\t\t$(this).after('<!-- ' + nested.length + ' -->');\n\t\t\t\tnested.push($('<div />').append($(this)));\n\t\t\t});\n\n\t\t\tresult.html(result.html().replace(regex, function (match, p1) {\n\t\t\t\treturn '<strong class=\"search-match\">' + p1 + '</strong>';\n\t\t\t}));\n\n\t\t\tnested.forEach(function (nestedEl, i) {\n\t\t\t\tresult.html(result.html().replace('<!-- ' + i + ' -->', function () {\n\t\t\t\t\treturn nestedEl.html();\n\t\t\t\t}));\n\t\t\t});\n\t\t});\n\n\t\t$('.search-result-text').find('img:not(.not-responsive)').addClass('img-responsive');\n\t}\n\n\tfunction handleSavePreferences() {\n\t\t$('#save-preferences').on('click', function () {\n\t\t\tstorage.setItem('search-preferences', JSON.stringify(getSearchDataFromDOM()));\n\t\t\tapp.alertSuccess('[[search:search-preferences-saved]]');\n\t\t\treturn false;\n\t\t});\n\n\t\t$('#clear-preferences').on('click', function () {\n\t\t\tstorage.removeItem('search-preferences');\n\t\t\tvar query = $('#search-input').val();\n\t\t\t$('#advanced-search')[0].reset();\n\t\t\t$('#search-input').val(query);\n\t\t\tapp.alertSuccess('[[search:search-preferences-cleared]]');\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tfunction enableAutoComplete() {\n\t\tvar userEl = $('#posted-by-user');\n\t\tuserEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\t\tautocomplete.user(userEl.siblings('.bootstrap-tagsinput').find('input'));\n\n\t\tvar tagEl = $('#has-tags');\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\n\t\tautocomplete.tag(tagEl.siblings('.bootstrap-tagsinput').find('input'));\n\t}\n\n\treturn Search;\n});\n"]}